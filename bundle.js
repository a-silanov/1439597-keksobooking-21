(()=>{"use strict";var e,t,n,r,o,i,a,u,d,c,l,s,f,m,p,v,y,w,h,g,S,_,E,L,q,b,C,k,x,N,T,I,A,j,D,M,V,H,R;t=document.querySelector(".map__filters"),n=t.querySelector("#housing-type"),r=t.querySelector("#housing-price"),o=t.querySelector("#housing-rooms"),i=t.querySelector("#housing-guests"),a=t.querySelector("#housing-features"),u=a.querySelector("#filter-wifi"),d=a.querySelector("#filter-dishwasher"),c=a.querySelector("#filter-parking"),l=a.querySelector("#filter-washer"),s=a.querySelector("#filter-elevator"),f=a.querySelector("#filter-conditioner"),m=function(e,t){return e.some((function(e){return e===t}))},p=function(e){var t=e;return"any"!==n.value&&(t=t.filter((function(e){return e.offer.type===n.value}))),"low"===r.value?t=t.filter((function(e){return e.offer.price<1e4})):"middle"===r.value?t=t.filter((function(e){return e.offer.price>=1e4&&e.offer.price<5e4})):"high"===r.value&&(t=t.filter((function(e){return e.offer.price>=5e4}))),"any"!==o.value&&(t=t.filter((function(e){return Number(e.offer.rooms)===Number(o.value)}))),"any"!==i.value&&(t=t.filter((function(e){return Number(e.offer.capacity)===Number(i.value)}))),u.checked&&(t=t.filter((function(e){return m(e.offer.features,u.value)}))),d.checked&&(t=t.filter((function(e){return m(e.offer.features,d.value)}))),c.checked&&(t=t.filter((function(e){return m(e.offer.features,c.value)}))),l.checked&&(t=t.filter((function(e){return m(e.offer.features,l.value)}))),s.checked&&(t=t.filter((function(e){return m(e.offer.features,s.value)}))),f.checked&&(t=t.filter((function(e){return m(e.offer.features,f.value)}))),t},t.addEventListener("change",(function(){window.card.close(),window.pin.delete();var t=p(window.data.cacheRentObjects);e&&window.clearTimeout(e),e=window.setTimeout((function(){window.pin.render(t)}),500)})),window.filter={use:p},v=function(e,t,n,r){var o=new XMLHttpRequest;return o.responseType="json",o.addEventListener("load",(function(){200===o.status?e(o.response):t("Статус ответа: "+o.status+" "+o.statusText)})),o.addEventListener("error",(function(){t("Произошла ошибка соединения")})),o.addEventListener("timeout",(function(){t("Запрос не успел выполниться за "+o.timeout+"мс")})),o.timeout=1e4,o.open(n,r),o},window.backend={load:function(e,t){v(e,t,"GET","https://js.dump.academy/keksobooking/data").send()},save:function(e,t,n){v(t,n,"POST","https://js.dump.academy/keksobooking").send(e)}},y=document.querySelector("#error").content.querySelector(".error"),w=y.querySelector(".error__message"),h=y.querySelector(".error__button"),g=document.querySelector("#success").content.querySelector(".success"),S=function(){y.remove(),document.removeEventListener("mousedown",S),h.removeEventListener("click",S),document.removeEventListener("keydown",E)},_=function(){g.remove(),document.removeEventListener("mousedown",_),document.removeEventListener("keydown",L)},E=function(e){"Escape"===e.key&&S()},L=function(e){"Escape"===e.key&&_()},window.message={error:function(e){w.textContent=e,document.querySelector("main").insertAdjacentElement("afterbegin",y),document.addEventListener("mousedown",S),h.addEventListener("click",S),document.addEventListener("keydown",E)},success:function(){document.querySelector("main").insertAdjacentElement("afterbegin",g),document.addEventListener("mousedown",_),document.addEventListener("keydown",L)}},window.data={rentObjectType:["palace","flat","house","bungalo"],rentObjectCheckTime:["12:00","13:00","14:00"],rentObjectFeatures:["wifi","dishwasher","parking","washer","elevator","conditioner"],ROOMS:10,GUESTS:5,countPhotos:5,countRentObjects:8,MAIN_PIN_WIDTH:62,MAIN_PIN_HEIGHT:80,MAX_PINS_QUANTITY:5,cacheRentObjects:null},q=function(e){return Math.floor(Math.random()*Math.floor(e))},window.util={disableElements:function(e){for(var t=0;t<e.length;t++)"#text"!==e[t].nodeName&&e[t].setAttribute("disabled",!0)},enableElements:function(e){for(var t=0;t<e.length;t++)"#text"!==e[t].nodeName&&e[t].removeAttribute("disabled")},getRandomInt:q,getRandomSlicedArray:function(e){return e.slice(0,q(e.length)+1)},getAddress:function(e){for(var t=e.style.left,n=e.style.top,r="",o="",i=0;i<t.length-2;i++)r+=t[i];r=Number(r)+window.data.MAIN_PIN_WIDTH/2;for(var a=0;a<n.length-2;a++)o+=Number(n[a]);return r+" "+(Number(o)+window.data.MAIN_PIN_HEIGHT)},removeChildElements:function(e){for(;e.firstChild;)e.removeChild(e.firstChild)}},b=document.querySelector(".map"),C=b.querySelector(".map__pin--main"),k=document.querySelector(".ad-form"),x=k.querySelectorAll("fieldset"),N=document.querySelector(".map__filters").childNodes,T=b.querySelector(".map__filters-container"),I=k.querySelector("#address"),A=null,j=function(e){e.preventDefault();var t={x:e.clientX,y:e.clientY},n=function(e){e.preventDefault();var n=t.x-e.clientX,r=t.y-e.clientY;t={x:e.clientX,y:e.clientY},C.style.top=C.offsetTop-r+"px",C.style.left=C.offsetLeft-n+"px",C.offsetLeft>b.offsetWidth-C.offsetWidth?C.style.left=b.offsetWidth-C.offsetWidth+"px":C.offsetTop>b.offsetHeight-C.offsetHeight?C.style.top=b.offsetHeight-C.offsetHeight+"px":C.offsetTop<b.offsetTop?C.style.top=b.offsetTop+"px":C.offsetLeft<b.offsetTop&&(C.style.left=b.offsetTop+"px")},r=function(e){e.preventDefault(),I.value=window.util.getAddress(C),document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",r)};document.addEventListener("mousemove",n),document.addEventListener("mouseup",r)},D=function(e){window.data.cacheRentObjects=e;var t=window.filter.use(e);window.pin.render(t),window.util.enableElements(N),T.classList.remove("hidden")},M=function(e){0!==e.button&&"Enter"!==e.key||(window.backend.load(D,window.message.error),k.classList.remove("ad-form--disabled"),window.util.enableElements(x),b.classList.remove("map--faded"),C.removeEventListener("mousedown",M),C.removeEventListener("keydown",M),window.form.setHandlers())},window.map={getInitialState:function(){C.removeEventListener("mousedown",j),C.style.left=A.x,C.style.top=A.y,window.util.disableElements(x),window.util.disableElements(N),k.classList.add("ad-form--disabled"),b.classList.add("map--faded"),T.classList.add("hidden"),C.addEventListener("mousedown",M),C.addEventListener("keydown",M),C.addEventListener("mousedown",j)},getMainPinDefaultCoordinates:function(){A={x:C.style.left,y:C.style.top}}},function(){var e=document.querySelector(".map"),t=document.querySelector("#card").content.querySelector(".map__card"),n=function(e){"Escape"===e.key&&r()},r=function(){var t=e.querySelector(".map__card");t&&(document.querySelector(".popup__close").removeEventListener("click",r),window.removeEventListener("keydown",n),t.remove())};window.card={show:function(o){return function(){r(),function(o){var i,a,u=document.createDocumentFragment(),d=t.cloneNode(!0);d.querySelector(".popup__title").textContent=o.offer.title,d.querySelector(".popup__text--address").textContent=o.offer.address,d.querySelector(".popup__text--price").textContent=o.offer.price+"₽/ночь",d.querySelector(".popup__type").textContent=(a="","flat"===(i=o).offer.type?a="Квартира":"bungalo"===i.offer.type?a="Бунгало":"house"===i.offer.type?a="Дом":"palace"===i.offer.type&&(a="Дворец"),a),d.querySelector(".popup__text--capacity").textContent=o.offer.rooms+" комнаты для "+o.offer.guests+" гостей",d.querySelector(".popup__text--time").textContent="Заезд после "+o.offer.checkin+", выезд до "+o.offer.checkout,d.querySelector(".popup__description").textContent=o.offer.description,d.querySelector(".popup__avatar").src=o.author.avatar,function(e,t){var n=t.querySelector(".popup__photos"),r=n.querySelector(".popup__photo");window.util.removeChildElements(n);for(var o=0;o<e.length;o++){var i=r.cloneNode(!0);i.src=e[o],n.appendChild(i)}}(o.offer.photos,d),function(e,t){var n=t.querySelector(".popup__features"),r=n.querySelector(".popup__feature");r.classList.remove("popup__feature--wifi"),window.util.removeChildElements(n);for(var o=0;o<e.length;o++){var i=r.cloneNode(!0),a="popup__feature--"+e[o];i.classList.add(a),i.textContent=e[o],n.appendChild(i)}}(o.offer.features,d),u.appendChild(d),e.insertBefore(u,e.querySelector(".map__filters-container")),window.addEventListener("keydown",n),e.querySelector(".popup__close").addEventListener("click",r)}(o)}},close:r}}(),V=document.querySelector(".map__pins"),H=document.querySelector("#pin").content.querySelector(".map__pin"),R=[],window.pin={render:function(e){for(var t=document.createDocumentFragment(),n=0;n<e.length;n++){var r=e[n],o=H.cloneNode(!0),i=o.querySelector("img");o.style="left: "+(r.location.x-50)+"px; top:"+(r.location.y-70)+"px;",i.src=r.author.avatar,i.alt=r.offer.title,o.addEventListener("click",window.card.show(r)),R.push(o),t.children.length<window.data.MAX_PINS_QUANTITY&&t.appendChild(o)}V.appendChild(t)},delete:function(){R.forEach((function(e){e.remove()}))}},function(){var e=["gif","jpg","jpeg","png"],t=document.querySelector(".ad-form"),n=t.querySelector("#title"),r=t.querySelector("#price"),o=t.querySelector("#type"),i=t.querySelector("#timein"),a=t.querySelector("#timeout"),u=t.querySelector("#room_number"),d=t.querySelector("#capacity"),c=t.querySelector("#avatar"),l=t.querySelector(".ad-form-header__preview").querySelector("img"),s=t.querySelector("#images"),f=t.querySelector(".ad-form__photo"),m=t.querySelector(".ad-form__reset"),p=t.querySelector("#description"),v=function(){n.value="",r.value="",p.value=""},y=function(t){return e.some((function(e){return t.endsWith(e)}))},w=function(){var e=c.files[0],t=e.name.toLowerCase();if(y(t)){var n=new FileReader;n.addEventListener("load",(function(){l.src=n.result})),n.readAsDataURL(e)}},h=function(){var e=s.files[0],t=e.name.toLowerCase();if(y(t)){var n=new FileReader;n.addEventListener("load",(function(){var e=document.createElement("img");e.width="70",e.height="70",e.src=n.result,f.appendChild(e)})),n.readAsDataURL(e)}},g=function(e){e.preventDefault(),v()},S=function(e){var t=e.target;t.validity.tooShort?t.setCustomValidity("Это поле должно состоять минимум из "+t.minLength+" символов."):t.validity.tooLong?t.setCustomValidity("Это поле должно состоять максимум из "+t.maxLength+" символов."):t.validity.valueMissing?t.setCustomValidity("Обязательное поле"):t.setCustomValidity("")},_=function(e){var t=e.target;t.value.length<t.minLength?t.setCustomValidity("Это поле должно состоять минимум из "+t.minLength+" символов."):t.setCustomValidity("")},E=function(){var e=Number(r.value),t=Number(r.min),n=Number(r.max);""===r.value?r.setCustomValidity("Обязательное поле"):e<t?r.setCustomValidity("Значение этого поля не должно быть выше чем "+r.min):e>n?r.setCustomValidity("Значение этого поля не должно быть ниже чем "+r.max):r.setCustomValidity("")},L=function(e){var t=e.target;""===t.value?t.setCustomValidity("Обязательное поле"):(t.value>t.min||t.value<t.max)&&t.setCustomValidity("")},q=function(e){var t=e.target;"bungalo"===t.value?r.min=0:"flat"===t.value?r.min=1e3:"house"===t.value?r.min=5e3:"palace"===t.value&&(r.min=1e4),r.placeholder=r.min},b=function(e){var t=e.target===i?i:a,n=e.target===i?a:i;("12:00"===t.value||"13:00"===t.value||"14:00"===t.value)&&(n.value=t.value)},C=function(){var e="",t=Number(u.value),n=Number(d.value);t<n?e="Количество комнат должно быть больше или равно количеству гостей":100===t&&0!==n&&(e="Столько комнат - не для гостей"),u.setCustomValidity(e)},k=function(e){for(var t=e.target,n="",r=t.value.length-4;r<t.value.length;r++)n+=t.value[r];".png"===n&&".jpg"===n||t.setCustomValidity('Выберите файлы изображений с разрешением ".png" или ".jpg"')},x=function(e){e.preventDefault(),window.backend.save(new FormData(t),(function(){window.message.success(),window.pin.delete(),window.card.close(),window.form.reset(),window.map.getInitialState()}),window.message.error)};window.form={setHandlers:function(){n.addEventListener("invalid",S),n.addEventListener("input",_),r.addEventListener("invalid",E),r.addEventListener("input",L),o.addEventListener("change",q),a.addEventListener("change",b),i.addEventListener("change",b),u.addEventListener("change",C),d.addEventListener("change",C),c.addEventListener("input",k),c.addEventListener("change",w),s.addEventListener("input",k),s.addEventListener("change",h),t.addEventListener("submit",x,window.message.error),m.addEventListener("click",g)},reset:v}}(),window.map.getMainPinDefaultCoordinates(),window.map.getInitialState()})();