(()=>{"use strict";(()=>{const e=document.querySelector(".map__pins");window.globals={MAX_WIDTH:e.clientWidth,Features:{WIFI:"wifi",DISHWASHER:"dishwasher",PARKING:"parking",WASHER:"washer",CONDITIONER:"conditioner",ELEVATOR:"elevator"}}})(),(()=>{const e=e=>Math.floor(Math.random()*e);window.utils={onError:e=>{const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)},disableArrayElements:(e,t)=>{for(let r=0;r<e.length;r++)e[r].disabled=t},getRandomInInterval:(e,t)=>{let r=e+Math.random()*(t+1-e);return Math.floor(r)},getRandomInt:e,getRandomArrayElement:t=>t[e(t.length)],getRandomLengthArray:t=>{let r=e(t.length),o=[];for(let e=0;e<r;e++)o.push(t[e]);return o}}})(),(()=>{let e=["gif","jpg","jpeg","png"];const t=t=>{const r=t.name.toLowerCase();return e.some((e=>r.endsWith(e)))},r=(e,t)=>{const r=new FileReader;r.addEventListener("load",(()=>{t.src=r.result})),r.readAsDataURL(e)};window.photoUtils={clearPhotoBox:()=>{const e=document.querySelector(".ad-form__photo__item");null!==e&&e.remove()},initPhotoChouser:(e,o)=>{e.addEventListener("change",(()=>{const n=e.files[0];if(t(n)){let e=(e=>{const t=document.querySelector(".ad-form__photo__item");if(null!==t)return{element:t,image:t.querySelector("img")};{const t=(()=>{const e=document.createElement("div");e.classList.add("ad-form__photo__item");const t=document.createElement("img");return t.alt="фото квартиры",t.width="70",t.height="70",t.src="",e.appendChild(t),{element:e,image:t}})();return e.appendChild(t.element),t}})(o).image;r(n,e)}}))},initFileChoiser:(e,o)=>{e.addEventListener("change",(()=>{const n=e.files[0];t(n)&&r(n,o)}))}}})(),window.debounce=e=>{let t=null;return((...r)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...r)}),500)})()},window.eventUtils={isEscEvent(e,t){27===e.keyCode&&t()},isEscEventWithPreventDefault(e,t){window.eventUtils.isEscEvent(e,t),e.preventDefault()},isEnterEvent(e,t){13===e.keyCode&&t()},isEnterEventWithPreventDefault(e,t){window.eventUtils.isEnterEvent(e,t),e.preventDefault()}},(()=>{const e=(e,t)=>{let r=new XMLHttpRequest;return r.responseType="json",r.timeout=1e4,r.addEventListener("load",(()=>{200===r.status?e(r.response):400===r.status?t("Статус ответа: "+r.status+" "+JSON.stringify(r.response)):t("Статус ответа: "+r.status+" "+r.statusText)})),r.addEventListener("error",(()=>{t("Произошла ошибка соединения")})),r.addEventListener("timeout",(()=>{t("Запрос не успел выполниться за "+r.timeout+"мс")})),r};window.backendAPI={load:(t,r)=>{const o=e(t,r);o.open("GET","https://21.javascript.pages.academy/keksobooking/data"),o.send()},save:(t,r,o)=>{const n=e(r,o);n.open("POST","https://21.javascript.pages.academy/keksobooking"),n.send(t)}}})(),(()=>{const e="any",t=document.querySelector(".map__filters"),r=t.querySelectorAll("fieldset"),o=t.querySelectorAll(".map__filter"),n=t.querySelector('select[name="housing-type"]'),s=t.querySelector('select[name="housing-price"]'),a=t.querySelector('select[name="housing-rooms"]'),i=t.querySelector('select[name="housing-guests"]'),l=t.querySelector(".map__features"),c=l.querySelector("#filter-wifi"),d=l.querySelector("#filter-dishwasher"),u=l.querySelector("#filter-parking"),p=l.querySelector("#filter-washer"),m=l.querySelector("#filter-elevator"),f=l.querySelector("#filter-conditioner"),w=e=>{let t=[],r=e.length<=5?e.length:5;for(let o=0;o<r;o++)t.push(e[o]);return t},v=()=>{let t=(t=>{const r=t.filter((e=>e.offer.type===n.value));return n.value===e?t:r})(window.map.pins);t=(t=>{const r=t.filter((e=>{switch(s.value){case"low":return e.offer.price<1e4;case"middle":return e.offer.price>=1e4&&e.offer.price<=5e4;case"high":return e.offer.price>5e4;default:return!1}}));return s.value===e?t:r})(t),t=(t=>{const r=t.filter((e=>e.offer.rooms.toString()===a.value));return a.value===e?t:r})(t),t=(t=>{const r=t.filter((e=>e.offer.guests.toString()===i.value));return i.value===e?t:r})(t),t=(e=>{const t=(()=>{let e=[];return c.checked&&e.push(window.globals.Features.WIFI),d.checked&&e.push(window.globals.Features.DISHWASHER),u.checked&&e.push(window.globals.Features.PARKING),p.checked&&e.push(window.globals.Features.WASHER),f.checked&&e.push(window.globals.Features.CONDITIONER),m.checked&&e.push(window.globals.Features.ELEVATOR),e})();return e.filter((e=>{let r=!0;return t.forEach((t=>{-1!==e.offer.features.indexOf(t)||(r=!1)})),r}))})(t);const r=w(t);window.map.updateData(r),window.map.closeCard()},y=()=>{window.debounce(v)};window.filters={getOnlyWithOffer:e=>e.filter((e=>void 0!==e.offer&&null!==e.offer)),getTop5Pins:w,setInnactive:()=>{t.classList.add("map__filters--disabled"),window.utils.disableArrayElements(r,!0),window.utils.disableArrayElements(o,!0),t.reset()},setActive:()=>{t.classList.remove("map__filters--disabled"),window.utils.disableArrayElements(r,!1),window.utils.disableArrayElements(o,!1),n.addEventListener("change",y),s.addEventListener("change",y),a.addEventListener("change",y),i.addEventListener("change",y),l.addEventListener("change",y)}}})(),(()=>{const e={FLAT:"Квартира",BUNGALOW:"Бунгало",HOUSE:"Дом",PALACE:"Дворец"};let t=null;const r=document.querySelector(".map__filters-container"),o=t=>{const o=(t=>{const r=document.querySelector("#card").content.querySelector(".popup"),o=document.createDocumentFragment();return o.appendChild(((t,r)=>{let o=t.cloneNode(!0);return((e,t)=>{let r=t.querySelector(".popup__title");""!==e.offer.title?r.innerText=e.offer.title:r.remove()})(r,o),((e,t)=>{let r=t.querySelector(".popup__text--address");r.innerText=e.offer.address,""===e.offer.address&&r.remove()})(r,o),((e,t)=>{let r=t.querySelector(".popup__text--price");r.innerText=e.offer.price+"₽/ночь",""===e.offer.price&&r.remove()})(r,o),((t,r)=>{let o=r.querySelector(".popup__type");""!==t.offer.type?o.innerText=e[t.offer.type.toString().toUpperCase()]:o.remove()})(r,o),((e,t)=>{let r=t.querySelector(".popup__text--capacity");""!==e.offer.rooms&&""!==e.offer.guests?r.innerText=`${e.offer.rooms} комнаты для ${e.offer.guests} гостей`:r.remove()})(r,o),((e,t)=>{let r=t.querySelector(".popup__text--time");""!==e.offer.checkin&&""!==e.offer.checkout?r.innerText=`Заезд после ${e.offer.checkin}, выезд до ${e.offer.checkout}`:r.remove()})(r,o),((e,t)=>{const r=(e,t,r)=>{-1===e.indexOf(t)&&r.remove()},o=t.querySelector(".popup__features"),n=o.querySelector(".popup__feature--wifi");r(e.offer.features,window.globals.Features.WIFI,n);const s=o.querySelector(".popup__feature--dishwasher");r(e.offer.features,window.globals.Features.DISHWASHER,s);const a=o.querySelector(".popup__feature--parking");r(e.offer.features,window.globals.Features.PARKING,a);const i=o.querySelector(".popup__feature--washer");r(e.offer.features,window.globals.Features.WASHER,i);const l=o.querySelector(".popup__feature--elevator");r(e.offer.features,window.globals.Features.ELEVATOR,l);const c=o.querySelector(".popup__feature--conditioner");r(e.offer.features,window.globals.Features.CONDITIONER,c)})(r,o),((e,t)=>{let r=t.querySelector(".popup__description");""!==e.offer.description?r.innerText=e.offer.description:r.remove()})(r,o),((e,t)=>{const r=t.querySelector(".popup__photos");let o=r.querySelector(".popup__photo");o.remove();for(let t=0;t<e.offer.photos.length;t++){let n=o.cloneNode(!1);n.src=e.offer.photos[t],r.appendChild(n)}})(r,o),((e,t)=>{let r=t.querySelector(".popup__avatar");""!==e.author.avatar?r.src=e.author.avatar:r.remove()})(r,o),o})(r,t)),o})(t);return r.parentElement.appendChild(o)},n=e=>{window.eventUtils.isEscEventWithPreventDefault(e,s)},s=()=>{const e=document.querySelector(".popup");null!==e&&e.remove(),document.removeEventListener("keydown",n)};window.card={show:e=>{null!==t&&s(),t=o(e.data),window.mapPins.markActive(e.element),(()=>{const e=document.querySelector(".popup");document.addEventListener("keydown",n);const t=e.querySelector(".popup__close");t.addEventListener("keydown",(e=>{window.eventUtils.isEnterEvent(e,s)})),t.addEventListener("click",(()=>{s()}))})()},close:s}})(),(()=>{const e=document.querySelector(".map__pin--main"),t=Math.floor(e.offsetWidth/2),r=e.offsetHeight,o=(e,o)=>{let n=e.cloneNode(!0),s=n.querySelector("img");return s.src=o.author.avatar,s.alt=o.offer.title,n.style.left=o.location.x-t+"px",n.style.top=o.location.y+r+"px",n.addEventListener("click",(()=>{const e={element:n,data:o};window.card.show(e)})),n},n=()=>{let e=document.querySelectorAll(".map__pin");Array.prototype.slice.call(e).forEach((e=>{e.classList.contains("map__pin--main")||e.remove()}))};window.mapPins={create:e=>{n();const t=(e=>{const t=document.querySelector("#pin").content.querySelector(".map__pin"),r=document.createDocumentFragment();for(let n=0;n<e.length;n++)r.appendChild(o(t,e[n]));return r})(e);document.querySelector(".map__pins").appendChild(t)},clear:n,markActive:e=>{let t=document.querySelectorAll(".map__pin");Array.prototype.slice.call(t).forEach((e=>{e.classList.contains("map__pin--main")||e.classList.remove("map__pin--active")})),e.classList.add("map__pin--active")}}})(),(()=>{const e=document.querySelector(".map__pin--main"),t=Math.floor(e.offsetWidth/2),r=e.offsetHeight,o=document.querySelector(".ad-form"),n=o.querySelectorAll("fieldset"),s=document.querySelector(".ad-form__field input[type=file]"),a=document.querySelector(".ad-form-header__preview img");window.photoUtils.initFileChoiser(s,a);const i=document.querySelector(".ad-form__upload input[type=file]"),l=document.querySelector(".ad-form__photo");window.photoUtils.initPhotoChouser(i,l);const c=document.querySelector("#address"),d=(e,t)=>{c.value=`${e},${t}`},u={setInnactiveState(){(()=>{const o=e.offsetLeft+t,n=e.offsetTop+Math.floor(r/2);d(o,n)})(),c.disabled=!0,c.placeholder=c.value},update(){const o=e.offsetLeft+t,n=e.offsetTop-r;d(o,n)},setActiveState(){this.update()}},p=document.querySelector("#type"),m=document.querySelector("#title");m.setAttribute("minlength",30),m.setAttribute("maxlength",30),m.setAttribute("required","");const f=document.querySelector("#price");f.setAttribute("required",""),f.setAttribute("max",1e6);const w=()=>{switch(p.value){case"bungalow":f.setAttribute("min",0),f.setAttribute("placeholder",0);break;case"flat":f.setAttribute("min",1e3),f.setAttribute("placeholder",1e3);break;case"house":f.setAttribute("min",5e3),f.setAttribute("placeholder",5e3);break;case"palace":f.setAttribute("min",1e4),f.setAttribute("placeholder",1e4);break;default:f.setAttribute("min",0),f.setAttribute("placeholder",0)}};w(),p.addEventListener("change",(()=>{w()}));const v=document.querySelector("#timein"),y=document.querySelector("#timeout");v.addEventListener("change",(()=>{y.selectedIndex=v.selectedIndex})),y.addEventListener("change",(()=>{v.selectedIndex=y.selectedIndex}));const h=document.querySelector("#room_number"),_=document.querySelector("#capacity"),S=e=>{let t="";switch(h.value){case"1":"1"!==_.value&&(t="1 комната для 1 гостя!");break;case"2":"1"!==_.value&&"2"!==_.value&&(t="2 комнаты для 2 гостей или для 1 гостя!");break;case"3":"1"!==_.value&&"2"!==_.value&&"3"!==_.value&&(t="3 комнаты для 3 гостей, для 2 гостей или для 1 гостя!");break;case"100":"0"!==_.value&&(t="100 комнат не для гостей!");break;default:t="Выбрано не подержиаемое количество комнат!"}e.target.setCustomValidity(t),e.target.reportValidity()};_.addEventListener("change",S),h.addEventListener("change",S);const E=e=>{let t=null;const r=()=>{e.remove(),t()},o=()=>{r()};document.body.addEventListener("click",o);const n=e=>{window.eventUtils.isEscEventWithPreventDefault(e,r)};document.body.addEventListener("keydown",n);const s=e.querySelector(".error__button");null!==s&&s.addEventListener("click",o),t=()=>{document.body.removeEventListener("click",o),document.body.removeEventListener("keydown",n)}},g=()=>{window.map.setInnactive(),(()=>{const e=document.querySelector("#success ").content.querySelector(".success").cloneNode(!0);document.querySelector(".map").appendChild(e),E(e)})()},q=e=>{(e=>{const t=document.querySelector("#error ").content.querySelector(".error").cloneNode(!0);t.querySelector(".error__message").textContent=e,document.querySelector("main").insertAdjacentElement("afterbegin",t),E(t)})(e)};o.addEventListener("submit",(e=>{let t=new FormData(o);t.append("address",c.value),window.backendAPI.save(t,g,q),e.preventDefault()})),o.querySelector(".ad-form__reset").addEventListener("click",(e=>{window.map.setInnactive(),e.preventDefault()})),window.form={setInnactiveState:()=>{window.utils.disableArrayElements(n,!0),o.classList.add("ad-form--disabled"),u.setInnactiveState(),o.reset(),window.photoUtils.clearPhotoBox(),a.src="img/muffin-grey.svg"},setActiveState:()=>{o.classList.remove("ad-form--disabled"),window.utils.disableArrayElements(n,!1),_.selectedIndex=2,u.setActiveState()},updateAddresCoord:u.update}})(),(()=>{let e=0;const t=document.querySelector(".map"),r=document.querySelector(".map__pin--main"),o=r.style.left,n=r.style.top,s=e=>{t.classList.remove("map--faded"),window.filters.setActive(),window.map.pins=window.filters.getOnlyWithOffer(e);const r=window.filters.getTop5Pins(window.map.pins);window.map.updateData(r),window.form.setActiveState()},a=()=>{0===e&&(e=1,window.backendAPI.load(s,window.utils.onError))};r.addEventListener("mousedown",(e=>{0===e.button&&a()})),r.addEventListener("keydown",(e=>{window.eventUtils.isEnterEventWithPreventDefault(e,a)})),r.addEventListener("mousedown",(e=>{0===e.button&&a(),e.preventDefault();let t={x:e.clientX,y:e.clientY},o=!1;const n=e=>{e.preventDefault(),o=!0;let n=t.x-e.clientX,s=t.y-e.clientY;t={x:e.clientX,y:e.clientY};let a=r.offsetTop-s;a>630&&(a=630),a<130&&(a=130);const i=r.offsetLeft-n;r.style.top=a+"px",r.style.left=i+"px",window.form.updateAddresCoord()},s=e=>{if(e.preventDefault(),document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",s),o){const e=t=>{t.preventDefault(),r.removeEventListener("click",e)};r.addEventListener("click",e)}};document.addEventListener("mousemove",n),document.addEventListener("mouseup",s)})),window.map={pins:[],closeCard:()=>{window.card.close()},setInnactive:()=>{t.classList.add("map--faded"),r.style.top=n,r.style.left=o,window.mapPins.clear(),window.card.close(),window.filters.setInnactive(),window.form.setInnactiveState(),e=0},setActive:a,updateData(e){window.mapPins.create(e)}}})(),window.map.setInnactive()})();